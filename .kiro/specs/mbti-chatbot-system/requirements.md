# MBTI チャットボットシステム 要件定義書

## はじめに

本システムは、MBTI（Myers-Briggs Type Indicator）を活用したパーソナライズドチャットボットシステムのMVPです。ユーザーの性格タイプに基づいて最適化されたAIアシスタントとの対話を提供し、Supabaseによる永続化とGPT-5 + LangGraphによるリアルタイムストリーミングを実現します。

## 要件

### 要件1: ユーザー認証とプロフィール管理

**ユーザーストーリー:** ユーザーとして、安全にアカウントを作成し、自分のMBTI性格タイプを設定したい。これにより、パーソナライズされたチャット体験を受けることができる。

#### 受入基準

1. WHEN ユーザーがメールアドレスを入力してサインアップを実行 THEN システムはSupabase AuthのMagic Linkを送信する
2. WHEN ユーザーがMagic Linkをクリック THEN システムはユーザーを認証し、MBTIプロフィール設定画面に遷移する
3. WHEN ユーザーが16のMBTIタイプから選択 THEN システムはプロフィールにMBTIタイプを保存する
4. WHEN ユーザーが「不明」を選択 THEN システムはMBTI簡易診断（24問、5段階評価）に自動遷移する
5. WHEN MBTI診断が完了 THEN システムは結果を自動的にプロフィールに保存し、確定する
6. WHEN ユーザーがプロフィール編集画面にアクセス THEN システムはMBTIタイプの変更と再診断を可能にする

### 要件2: リアルタイムチャット機能

**ユーザーストーリー:** ユーザーとして、自分のMBTIタイプに最適化されたAIボットとリアルタイムでチャットしたい。これにより、自然で快適な対話体験を得ることができる。

#### 受入基準

1. WHEN ユーザーがログイン完了かつMBTI確定済み THEN システムはデフォルトの推奨Botでチャットを開始する
2. WHEN ユーザーがMBTI未確定 THEN システムは診断画面に遷移する
3. WHEN ユーザーがメッセージを送信 THEN システムはSSEでトークンを順次表示する（初回トークン<700ms、連続トークン>25 tok/s）
4. WHEN AIが応答を生成中 THEN システムはLangGraphのstream/streamEventsを利用してリアルタイム進捗を表示する
5. WHEN チャット中にユーザーが停止ボタンをクリック THEN システムは応答生成を即座に中断する
6. WHEN ユーザーがチャット履歴をクリア THEN システムは現在のセッションをリセットし、新規スレッドを作成する
7. WHEN チャットセッションが作成/更新 THEN システムはSupabaseに即時保存し、RLSでユーザー隔離を実施する

### 要件3: チャットボット性格パラメータ管理

**ユーザーストーリー:** ユーザーとして、AIボットの性格特性を細かく調整したい。これにより、自分の好みに合わせたカスタマイズされた対話相手を作ることができる。

#### 受入基準

1. WHEN ユーザーが性格エディタにアクセス THEN システムは以下のパラメータをスライダー/トグルで表示する：温かさ、フォーマル度、簡潔さ、ユーモア、共感、主導性、創造性、厳密さ、絵文字使用、ステップ数
2. WHEN ユーザーがパラメータを調整 THEN システムは即座にプレビューを表示する
3. WHEN ユーザーがカスタム設定を保存 THEN システムはパラメータをbot_personasテーブルに保存する
4. WHEN 保存済みパラメータが存在 THEN システムはテンプレートに埋め込んでシステムプロンプトを動的生成する
5. WHEN ユーザーがボット一覧を表示 THEN システムはプリセット＋ユーザー保存分を表示する
6. WHEN ユーザーが既存ボットを編集 THEN システムは現在の設定値をエディタに読み込む

### 要件4: MBTI基盤の推奨システム

**ユーザーストーリー:** ユーザーとして、自分のMBTIタイプに基づいて相性の良いAIボットを自動推奨してもらいたい。これにより、最適な対話パートナーを簡単に見つけることができる。

#### 受入基準

1. WHEN ユーザーのMBTIタイプが確定 THEN システムは16タイプのプリセットPersonaから相性スコアを計算する
2. WHEN 相性スコア計算時 THEN システムは4軸（E/I, S/N, T/F, J/P）で補完一致に+1、ミスマッチ0として合計スコアを算出する
3. WHEN 同点の候補が存在 THEN システムは性格パラメータ距離（L2距離）で優先順位を決定する
4. WHEN 推奨計算完了 THEN システムはTop3を「おすすめ性格」としてUIに表示する
5. WHEN ユーザーが推奨ボットを選択 THEN システムは手動微調整（スライダー上書き）を可能にする
6. WHEN ユーザーが推奨ボットをカスタマイズ後保存 THEN システムは新しいカスタムボットとして保存する
7. WHEN MBTI軸から性格パラメータへの変換時 THEN システムは線形写像を適用する（E高→主導性/多弁↑、N高→抽象度/比喩↑、F高→共感/配慮↑、J高→構造化/アウトライン↑）

### 要件5: MBTI簡易診断機能

**ユーザーストーリー:** ユーザーとして、自分のMBTIタイプが分からない場合に簡易診断を受けたい。これにより、適切な性格タイプを特定してパーソナライズされたサービスを利用できる。

#### 受入基準

1. WHEN ユーザーが「MBTIタイプが不明」を選択 THEN システムは24問の診断画面に遷移する
2. WHEN 診断画面表示時 THEN システムは4軸×各6問の設問を5段階評価（全く当てはまらない〜とても当てはまる）で表示する
3. WHEN 各設問表示時 THEN システムはaxis（EI/SN/TF/JP）とpolarity（+1/-1）を内部的に管理する
4. WHEN ユーザーが全24問に回答 THEN システムは各軸の総和でE/I等を判定する
5. WHEN 診断結果が確定 THEN システムはMBTIタイプをprofiles.mbtiに自動保存する
6. WHEN 診断完了後 THEN システムは確定したタイプに基づいて推奨ボット画面に遷移する
7. WHEN 設問内容作成時 THEN システムは自作設問を使用し、権利問題を回避する

### 要件6: データ永続化とセキュリティ

**ユーザーストーリー:** ユーザーとして、自分のチャット履歴と設定が安全に保存され、他のユーザーからアクセスできないようにしたい。これにより、プライバシーを保護しながら継続的にサービスを利用できる。

#### 受入基準

1. WHEN ユーザーがアカウント作成 THEN システムはSupabase RLSを有効化し、ユーザー自身のデータのみアクセス可能にする
2. WHEN チャットメッセージが送受信 THEN システムはsessions/messagesテーブルに即時保存する
3. WHEN データベースアクセス時 THEN システムはauth.uid()を使用してユーザー隔離を実施する
4. WHEN ユーザーがプロフィール更新 THEN システムはprofilesテーブルの自分のレコードのみ更新可能にする
5. WHEN ボット設定保存時 THEN システムはbot_personasテーブルのowner_idで所有者を制限する
6. WHEN 診断結果保存時 THEN システムはmbti_answersテーブルにuser_idで紐付けて保存する
7. WHEN ブラウザから直接データベースアクセス THEN システムはRLSポリシーにより不正アクセスを防止する

### 要件7: ローカルデータ移行

**ユーザーストーリー:** 既存ユーザーとして、現在ローカルストレージに保存されているチャット履歴をクラウドに移行したい。これにより、データを失うことなく新機能を利用できる。

#### 受入基準

1. WHEN 既存ユーザーが初回ログイン THEN システムはlocalStorageの旧データ存在をチェックする
2. WHEN 旧データが存在 THEN システムは「インポート」モーダルを表示する
3. WHEN ユーザーがインポートを承認 THEN システムは旧データをサーバーにPOSTする
4. WHEN サーバーがインポートデータを受信 THEN システムはsessions/messagesテーブルに一括保存する
5. WHEN インポート成功 THEN システムはローカルストレージから旧データを削除する
6. WHEN インポート失敗 THEN システムはエラーメッセージを表示し、ローカルデータを保持する

### 要件8: システム性能とストリーミング

**ユーザーストーリー:** ユーザーとして、AIの応答が滑らかにストリーミング表示されることを期待する。これにより、自然な会話体験を得ることができる。

#### 受入基準

1. WHEN ユーザーがメッセージ送信 THEN システムは初回トークンを700ms以内に表示開始する
2. WHEN ストリーミング中 THEN システムは25 tok/s以上の速度でトークンを連続表示する
3. WHEN Route Handler実装時 THEN システムはReadableStreamを使用してSSEを直書きする
4. WHEN Next.js設定時 THEN システムはexport const dynamic = 'force-dynamic'を設定してキャッシュを回避する
5. WHEN LangGraph実装時 THEN システムはgraph.stream({streamMode:"messages"})またはgraph.streamEvents({version:"v2"})を使用する
6. WHEN SSEヘッダー設定時 THEN システムはtext/event-stream、no-cache、no-transform、keep-aliveを指定する
7. WHEN ストリーミングエラー発生時 THEN システムはSSE経由でエラーイベントを送信し、適切にストリームを終了する

### 要件9: ユーザーインターフェースと多言語対応

**ユーザーストーリー:** ユーザーとして、自分の好みの言語（日本語または英語）で直感的で使いやすいUIでシステムを操作したい。これにより、言語の壁なくストレスなく機能を利用できる。

#### 受入基準

1. WHEN システム表示時 THEN ユーザーは日本語または英語を選択可能である
2. WHEN 言語設定変更時 THEN システムはすべてのUIテキスト、メッセージ、エラー表示を選択言語で表示する
3. WHEN 初回アクセス時 THEN システムはブラウザの言語設定を検出し、対応言語（日本語/英語）を自動選択する
4. WHEN 非対応言語のブラウザ設定時 THEN システムはデフォルトで英語を表示する
5. WHEN MBTI診断実行時 THEN 設問と選択肢は選択言語で表示される
6. WHEN AIボットとの会話時 THEN システムプロンプトに言語指定を含め、選択言語での応答を促す
7. WHEN チャット画面表示時 THEN 入力欄、停止ボタン、セッション切替、タイトル編集機能が利用可能である
8. WHEN ボット管理画面表示時 THEN プリセット＋ユーザー保存分の一覧が表示される
9. WHEN 性格エディタ表示時 THEN スライダー/トグルで即時プレビューが可能である
10. WHEN 「おすすめ性格」タブ表示時 THEN Top3推奨ボットが選択可能な形で表示される
11. WHEN 設定画面表示時 THEN 既定Bot、既定温度、出力量上限、MBTI再診断、言語設定の変更が可能である
12. WHEN モバイル表示時 THEN レスポンシブデザインでPC/スマホ両対応である

### 要件10: エラーハンドリングと監視

**ユーザーストーリー:** ユーザーとして、システムエラーが発生した場合に適切な通知を受け、サービスが安定して動作することを期待する。

#### 受入基準

1. WHEN APIエラー発生時 THEN システムはSSE経由でエラーイベントを送信する
2. WHEN ネットワークエラー発生時 THEN システムは適切なエラーメッセージをUIに表示する
3. WHEN ストリーミング中断時 THEN システムはストリームを適切に終了し、リソースを解放する
4. WHEN サーバーログ記録時 THEN システムはSSE開始/終了/中断イベントを記録する
5. WHEN 平日日中の稼働時 THEN システムは99.5%の可用性を維持する
6. WHEN 認証エラー発生時 THEN システムはログイン画面にリダイレクトする
7. WHEN データベースエラー発生時 THEN システムは適切なフォールバック処理を実行する